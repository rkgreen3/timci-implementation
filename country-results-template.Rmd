---
title: "Implementation Study Analysis"
<<<<<<< HEAD
date: "`r Sys.Date()`"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    theme: flatly 
---

```{r,echo=FALSE,results='hide'}

# install these packages if not already on your computer
library(plyr)
library(dplyr)
library(tableone)
library(knitr)
library(kableExtra)
library(epiDisplay)
library(Hmisc)


# Read in (cleaned) data
# Create a text file from within R with the name ".Renviron", then define the variables as below
# filename = "<current-file-name>.csv"
# COUNTRY = "<your-country>"
# After adding the file and content restart R session and you are good to go
# The Renviron will be ignored when pushing changes to Github

# Basic data cleaning/formatting -- do this before subset so all levels are present

## Relationship of caregiver to child 
df_og$cg_relationship <- factor(df_og$cg_relationship,
                                  labels = c("Mother and Father","Mother and Grandmother","Mother only",
                                             "Father only", "Grandmother only","Grandfather only","Sibling",
                                             "Other family member","Community member"))

## Convert categorical variables into factors
df_og$age_cat <- factor(df_og$age_cat, labels=c("0-1 month", "2-11 months", "12-59 months"))

## Sex - omitted since data collected on 'sex' was that of the providers and not the caregiver/child

## Maternal education
df_og$cg_edu_mother<- factor(df_og$cg_edu_mother,levels = c(1,2,3,4,5,6,7,8,9),
                              labels = c("Primary", "Post-primary/vocational", "Secondary", "Diploma/certificate", "Bachelors degree or equivalent", "Masters degree or equivalent", "Other", "Never attended any formal schooling", "Declined"))

## Household head
df_og$household_head<- factor(df_og$household_head,levels = c(1,2,3,4,5,6,7,8,9,10,11,12),
                               labels = c("Female", "Mother of sick child", "Grandmother (maternal)", "Grandmother (paternal)", "Other female", "Male", "Father of sick child", "Grandfather (maternal)", "Grandfather (paternal)", "Other male", "Unknown/uncertain", "Declined"))

## Household toilet
df_og$household_toilet<- factor(df_og$household_toilet,levels = c(1,2,3,4,5,6,7,8,9,10,11),
                                 labels = c("Flush or pour-flush toilet", "Ventilated improved pit latrine", "Pit latrine with slab", "Pit latrine without slab/open pit", "Composting toilet", "Bucket", "Hanging toilet", "No facility/bush", "Other", "Unknown/uncertain", "Declined"))

## Household fuel
df_og$household_fuel<- factor(df_og$household_fuel,levels = c(1,2,3,4,5,6,7,8,9),
                               labels = c("Firewood", "Charcoal", "Solar", "Biomass fuel", "Cooking gas (LPG fuel)", "Electricity", "Other", "Unknown/uncertain", "Declined"))

## Household water located in house
df_og$household_water_loc<- factor(df_og$household_water_loc, levels= c(1,2),
                                    labels = c("In the house/grounds", "Outside the grounds"))

## Household floor
df_og$household_floor <- factor(df_og$household_floor, 
                                 levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20),
                                 labels = c("Natural", "Earth", "Sand", "Clay", "Mud", "Dung", "Rudimentary", "Tablets/Wood planks",
                                            "Palm", "Bamboo", "Mat", "Adobe", "Finished", "Parquet", "Vinyl", "Linoleum", "Ceramic,tile",
                                            "Carpet", "Stone, cement", "Bricks"))

# Define country and subset
COUNTRY <- Sys.getenv("COUNTRY")
df <- subset(df_og, df_og$country==COUNTRY)

```

# Table 1: Patient demographic and household characteristics. {.tabset}

```{r}
# Specify all the variables you want to treat as factors
factorVars <- c("age_cat")

# Specify all the variables to include
myVars <- c("age_cat", "cg_relationship", "cg_age", "cg_edu_mother", "household_head",
            "household_toilet", "household_fuel", "household_water_loc","household_floor")

# CreateTableOne:
out1 <- CreateTableOne(vars = myVars,
                       data = df,
                       factorVars = factorVars,
                       strata = "facility_name",
                       test = FALSE,
                       addOverall = TRUE) 

t1_overall <- print(out1,
            cramVars = c("household_water_loc"))

# Create row labels
t1lab <- c("N",
           "Age Category (%)", "0-1 month", "2-11 months", "12-59 months",
            "Caregiver Relationship (%)", "Mother and father", "Mother and grandmother", "Mother only", "Father only", "Grandmother only", "Grandfather only", "Sibling", "Other family member", "Community member", "Caregiver Age (mean (SD))", 
            "Maternal Education (highest level attended) (%)", "Primary", "Post-Primary/Vocational", "Secondary", "Diploma/Certificate", "Bachelors degree or equivalent", "Masters degree or equivalent", 
              "Other", "Never attended any formal schooling", "Declined",
            "Household head (%)", "Female", "Mother of sick child", "Grandmother (maternal)", "Grandmother (paternal)", "Other female", "Male", "Father of sick child", "Grandfather (maternal)", "Grandfather (paternal)", "Other male", "Unknown/Uncertain", "Declined",
            "What kind of toilet facility do members of your household usually use? (%)", "Flush or pour-flush toilet", "Ventilated improved pit latrine", "Pit latrine with slab", "Pit latrine without slab/open pit", "Composting toilet", "Bucket", "Hanging toilet", "No facility/bush", "Other", "Unknown/Uncertain", "Declined",
            "What type of fuel is mainly used for cooking in the household? (%)", "Firewood","Charcoal", "Solar",  "Biomass fuel", "Cooking gas (LPG fuel)", "Electricity", "Other", "Unknown/Uncertain", "Declined",
            "Household water location = In the house or grounds/ Outside the grounds (%)",
            "What is the main material of the floor of the household? (%)", "Natural", "Earth", "Sand", "Clay", "Mud", "Dung", "Rudimentary", "Tablets/Wood planks", "Palm", "Bamboo", "Mat", "Adobe", "Finished", "Parquet", "Vinyl", "Linoleum", "Ceramic,tile", "Carpet", "Stone, cement", "Bricks")


# Add row labels
rownames(t1_overall) <- c(t1lab)

# Table formatting
t1 <- kable(t1_overall) %>%
  kable_styling(bootstrap_options=c("striped","hover","condensed"), position = "center")  %>%
  add_indent(c(3:5, 7:15, 17:26, 28:39, 41:51, 53:61, 64:83)) %>%
  pack_rows("Demographic Characteristics)", 2, 26) %>%
  pack_rows("Household Characteristics", 27, 83)
```
`r t1`

## Additional detail
```{r}
#CARACTERISTIQUES 

## Age
df$birthday<-as.Date(paste(df$birth_year,df$birth_month,"15",sep = "-"),format = "%Y-%m-%d")
df$visit_date_1=as.Date(df$visit_date,format = "%d/%m/%Y")
df$visit_date_2=format(df$visit_date_1,"%Y-%m-%d")
df$Age_categ = difftime(df$visit_date_2,df$birthday,units = "days")
df$age_m = df$Age_categ/30
df$age_m=as.numeric(df$age_m)
df$age_m_1 = cut(df$age_m,
             breaks = c(0,2,12,60),
             right = F,
             labels = c("0-1","2-11","12-59"))
describe(df$age_m_1)
tabpct(df$facility_name,df$age_m_1)
## Sex

df$sex=as.factor(df$sex)
describe(df$sex)
tabpct(df$facility_name,df$sex)

## Relationship of caregiver to child

describe(df$cg_relationship)
tabpct(df$facility_name,df$cg_relationship)

## Caregiver age
summ(df$cg_age)
 tapply(df$cg_age, df$facility_name, mean,na.rm=T)

## Maternal education
df$cg_edu_mother[df$cg_edu_mother==999] = NA
df$cg_edu_mother=as.factor(df$cg_edu_mother)
describe(df$cg_edu_mother) 
tabpct(df$facility_name,df$cg_edu_mother)

## Household head
df$household_head[df$household_head==99] = NA
df$household_head=as.factor(df$household_head)
describe(df$household_head)
tabpct(df$facility_name,df$household_head)

## Household toilet
df$household_toilet[df$household_toilet==999] = NA
df$household_toilet=as.factor(df$household_toilet)
describe(df$household_toilet)
tabpct(df$facility_name,df$household_toilet)

## Household fuel

df$household_fuel=as.factor(df$household_fuel)
describe(df$household_fuel)
tabpct(df$facility_name,df$household_fuel)

## Household water located in house

df$household_water_loc=as.factor(df$household_water_loc)
describe(df$household_water_loc)
tabpct(df$facility_name,df$household_water_loc)

## Household floor

df$household_floor=as.factor(df$household_floor)
describe(df$household_floor)
tabpct(df$facility_name,df$household_floor)
```


# Table 2: Patient clinical and care seeking characteristics.


```{r,echo=FALSE,fig.show='hide'}

## Reason for visit to clinic
df$facility_choice_reason___2 = as.factor(df$facility_choice_reason___2)
describe(df$facility_choice_reason___2)
tabpct(df$facility_name,df$facility_choice_reason___2)

df$facility_choice_reason___3 = as.factor(df$facility_choice_reason___3)
describe(df$facility_choice_reason___3)
tabpct(df$facility_name,df$facility_choice_reason___3)

df$facility_choice_reason___4 = as.factor(df$facility_choice_reason___4)
describe(df$facility_choice_reason___4)
tabpct(df$facility_name,df$facility_choice_reason___4)

df$facility_choice_reason___5 = as.factor(df$facility_choice_reason___5)
describe(df$facility_choice_reason___5)
tabpct(df$facility_name,df$facility_choice_reason___5)

df$facility_choice_reason___8 = as.factor(df$facility_choice_reason___8)
describe(df$facility_choice_reason___8)
tabpct(df$facility_name,df$facility_choice_reason___8)

## ## Mode of travel to clinic

df$travel_mode___1=as.factor(df$travel_mode___1) 
describe(df$travel_mode___1)
tabpct(df$facility_name,df$travel_mode___1)

df$travel_mode___2=as.factor(df$travel_mode___2)
describe(df$travel_mode___2)

df$travel_mode___3=as.factor(df$travel_mode___3)
describe(df$travel_mode___3)
tabpct(df$facility_name,df$travel_mode___3)

df$travel_mode___4=as.factor(df$travel_mode___4)
describe(df$travel_mode___4)

df$travel_mode___5=as.factor(df$travel_mode___5) 
describe(df$travel_mode___5)

df$travel_mode___6=as.factor(df$travel_mode___6)
describe(df$travel_mode___6)
tabpct(df$facility_name,df$travel_mode___6)

df$travel_mode___7=as.factor(df$travel_mode___7)
describe(df$travel_mode___7)
tabpct(df$facility_name,df$travel_mode___7)

df$travel_mode___8=as.factor(df$travel_mode___8)
describe(df$travel_mode___8)
tabpct(df$facility_name,df$travel_mode___8)

df$travel_mode___11=as.factor(df$travel_mode___11)
describe(df$travel_mode___11)
tabpct(df$facility_name,df$travel_mode___11)


## Travel time to arrive at clinic
df$travel_time[df$travel_time==999] = NA
df$travel_time[df$travel_time==99] = NA
df$travel_time=as.factor(df$travel_time)
describe(df$travel_time)
tabpct(df$facility_name,df$travel_time)

## Estimated amount of money spent for transport to arrive at clinic (USD)
df$travel_cost[df$travel_cost==999] = NA
df$travel_cost[df$travel_cost==99] = NA
df$travel_cost=as.factor(df$travel_cost)
describe(df$travel_cost)
tabpct(df$facility_name,df$travel_cost)
```

# Table 3: Use of PO device across facilities. {.tabset}

```{r,echo=FALSE,fig.show='hide'}
# Specify all the variables you want to treat as factors

factorVars <- c("used_po_yn", "correct_use_yn", "clinical_measures_complete")

# Specify all the variables to include in table (both continuous and categorical)
myVars <- c("used_po_yn", "correct_use_yn", "po_duration_min", "consult_duration_min", "clinical_measures_complete")

## issue identified w/duration variables, troubleshooting in progress in cleaning file

t3lab <- c("N", "Used PO device during encounter (%)", "PO device used correctly (%)", "Duration of PO device use, minutes (mean (SD))", "Consult duration, minutes (mean (SD))", "All clinical measures (SpO2, PR, RR, Temp) collected (%)")

out3 <- CreateTableOne(vars = myVars,
               data = df,
               factorVars = factorVars,
               strata = "facility_name",
               test = FALSE,
               addOverall = TRUE)
out3_overall <- print(out3)
rownames(out3_overall) <- c(t3lab) # Add row labels

out3 <- kable(print(out3_overall)) %>%
  kable_styling(bootstrap_options=c("striped","hover","condensed"), position = "center")
```
`r out3`

## Additional detail
```{r}
## PO device used during encounter
df$used_po_yn=as.factor(df$used_po_yn)
describe(df$used_po_yn)

## PO device used correctly
df$correct_use_yn=as.factor(df$correct_use_yn)
describe(df$correct_use_yn)
tabpct(df$facility_name,df$correct_use_yn)

## Duration of PO device use
df$po_stop1 <- as.POSIXct(df$po_stop, format="%d/%m/%Y %H:%M")
df$po_start1 <- as.POSIXct(df$po_start, format="%d/%m/%Y %H:%M")
df$duration_po =difftime(df$po_stop1,df$po_start1, units = "mins")
df$duration_po=as.numeric(df$duration_po)
summ(df$duration_po)
df$duration_po_1 = cut(df$duration_po,
                       breaks = c(0,1,3.1,5.1,10.1,30.1,60),
                       right = F,
                       labels = c("Moins une min","1 à 3 m","4-5m","6-10m","11-30","31-60"))
describe(df$duration_po_1)
tabpct(df$facility_name,df$duration_po_1)

## Consultation duration
df$consult_start=as.POSIXlt(df$consult_start, format = "%H:%M")
df$consult_stop=as.POSIXct(df$consult_stop, format = "%H:%M")
df$consultation_duration = difftime(df$consult_stop,df$consult_start,units = "mins")
df$consultation_duration=as.numeric(df$consultation_duration)
summ(df$consultation_duration)
df$consultation_duration_1 = cut(df$consultation_duration,
                       breaks = c(0,2.1,5.1,10.1,30.1,60.1,100),
                       right = F,
                       labels = c("2 min","3-5m","6-10m","11-30","31-60","Plus 60"))
describe(df$consultation_duration_1)
tabpct(df$facility_name,df$consultation_duration_1)

## Encounters where all clinical measurements were assessed

df$correct_use_measurements = df$correct_use_measurements___1 + df$correct_use_measurements___2 +
  df$correct_use_measurements___3 + df$correct_use_measurements___4
df$correct_use_measurements=as.factor(df$correct_use_measurements)
describe(df$correct_use_measurements)
tabpct(df$facility_name,df$correct_use_measurements)
```

The PO device was used consistently across encounters except for:
* `r sum(df_og$no_po_reason==1, na.rm = T)` instances where the device was broken
* `r sum(df_og$no_po_reason==2, na.rm = T)` instances where the battery was not charged
* `r sum(df_og$no_po_reason==3, na.rm = T)` instances where the device was being used in another part of the facility
* `r sum(df_og$no_po_reason==4, na.rm = T)` instances where the device was missing
* `r sum(df_og$no_po_reason==5, na.rm = T)` instances where the child was too fussy
* `r sum(df_og$no_po_reason==6, na.rm = T)` instances where the caregiver did not want it
* `r sum(df_og$no_po_reason==7, na.rm = T)` instances where the provider decided it was not needed

# Table 4: Clinical outcomes following implementation of PO device.
