---
title: "Implementation Study Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    theme: journal
---

# Background

The overall goal of this project is to reduce morbidity and mortality of sick children attending primary care facilities while supporting the rational and efficient use of diagnostics and medicines by healthcare providers. This study is focused on understanding the operational feasibility of multimodal pulse ox use in standard care. The results presented in this document describe several weeks of use of the Masimo pulse oximeter in primary care settings.

```{r setup, include=FALSE}
rm(list=ls())

knitr::opts_chunk$set(echo = FALSE)

# install these packages if not already on your computer
library(plyr)
library(dplyr)
library(tableone)
library(kableExtra)
library(epiDisplay)
library(Hmisc)


# Read in (cleaned) data
# Create a text file from within R with the name ".Renviron", then define the variables as below
# filename = "<current-file-name>.csv"
# COUNTRY = "<your-country>"
# After adding the file and content restart R session and you are good to go
# The Renviron will be ignored when pushing changes to Github

df_og <- read.csv(Sys.getenv("filename"))

# Basic data cleaning/formatting -- do this before subset so all levels are present

## Relationship of caregiver to child 
df_og$cg_relationship <- factor(df_og$cg_relationship,
                                  labels = c("Mother and Father","Mother and Grandmother","Mother only",
                                             "Father only", "Grandmother only","Grandfather only","Sibling",
                                             "Other family member","Community member"))

## Convert categorical variables into factors
df_og$age_cat <- factor(df_og$age_cat, labels=c("0-1 month", "2-11 months", "12-59 months"))

## Factor clinical variables
df_og$weight_yn <- factor(df_og$weight_yn, levels = c(0,1,2), labels = c("Unknown/not recorded", "Yes", "Recorded, not readable"))
df_og$height_yn <- factor(df_og$height_yn, levels = c(0,1), labels = c("Unknown/not recorded", "Yes"))
df_og$muac_yn <- factor(df_og$muac_yn, levels = c(0,1,2), labels = c("Unknown/not recorded", "Yes", "Recorded, not readable"))
df_og$wfh_yn <- factor(df_og$wfh_yn, levels = c(0,1), labels = c("Unknown/not recorded", "Yes"))
df_og$temp_yn <- factor(df_og$temp_yn, levels = c(0,1), labels = c("Unknown/not recorded", "Yes"))
df_og$hb_yn <- factor(df_og$hb_yn, levels = c(0,1,2), labels = c("Unknown/not recorded", "Yes", "Recorded, not readable"))

## Travel mode 
df_og$travel_mode <- factor(df_og$travel_mode, 
                                  labels = c("Walk","Bicycle","Motorcycle", "Public mini-van/bus", "Public taxi","Private taxi", "Own private car","Shared car", "Pack animals/carriage", "Other"))

## Referral
df_og$refferal <- factor(df_og$refferal, levels = c(1,2,4,5), labels = c("Urgent", "Non-urgent", "Recorded, not readable", "Recorded as not referred"))
                            
## Sex - omitted since data collected on 'sex' was that of the providers and not the caregiver/child

## Maternal education
df_og$cg_edu_mother<- factor(df_og$cg_edu_mother,levels = c(1,2,3,4,5,6,7,8,9),
                              labels = c("Primary", "Post-primary/vocational", "Secondary", "Diploma/certificate", "Bachelors degree or equivalent", "Masters degree or equivalent", "Other", "Never attended any formal schooling", "Declined"))

## Household head
df_og$household_head<- factor(df_og$household_head,levels = c(1,2,3,4,5,6,7,8,9,10,11,12),
                               labels = c("Female", "Mother of sick child", "Grandmother (maternal)", "Grandmother (paternal)", "Other female", "Male", "Father of sick child", "Grandfather (maternal)", "Grandfather (paternal)", "Other male", "Unknown/uncertain", "Declined"))

## Household toilet
df_og$household_toilet<- factor(df_og$household_toilet,levels = c(1,2,3,4,5,6,7,8,9,10,11),
                                 labels = c("Flush or pour-flush toilet", "Ventilated improved pit latrine", "Pit latrine with slab", "Pit latrine without slab/open pit", "Composting toilet", "Bucket", "Hanging toilet", "No facility/bush", "Other", "Unknown/uncertain", "Declined"))

## Household fuel
df_og$household_fuel<- factor(df_og$household_fuel,levels = c(1,2,3,4,5,6,7,8,9),
                               labels = c("Firewood", "Charcoal", "Solar", "Biomass fuel", "Cooking gas (LPG fuel)", "Electricity", "Other", "Unknown/uncertain", "Declined"))

## Household water located in house
df_og$household_water_loc<- factor(df_og$household_water_loc, levels= c(1,2),
                                    labels = c("In the house/grounds", "Outside the grounds"))

## Household floor
df_og$household_floor <- factor(df_og$household_floor, 
                                 levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20),
                                 labels = c("Natural", "Earth", "Sand", "Clay", "Mud", "Dung", "Rudimentary", "Tablets/Wood planks",
                                            "Palm", "Bamboo", "Mat", "Adobe", "Finished", "Parquet", "Vinyl", "Linoleum", "Ceramic,tile",
                                            "Carpet", "Stone, cement", "Bricks"))

# Define country and subset
COUNTRY <- Sys.getenv("COUNTRY")
df <- subset(df_og, df_og$country==COUNTRY)
```

This report contains data from **`r COUNTRY`**.

# Table 1: Patient demographic and household characteristics. {.tabset}

```{r include=FALSE}
# TO ADD: household_children, shared_toilet_yn, household_water_time

# Specify all the variables you want to treat as factors
factorVars <- c("age_cat")

# Specify all the variables to include
myVars <- c("age_cat", "cg_relationship", "cg_age", "cg_edu_mother", "household_head",
            "household_toilet", "household_fuel", "household_water_loc","household_floor")

# CreateTableOne:
out1 <- CreateTableOne(vars = myVars,
                       data = df,
                       factorVars = factorVars,
                       strata = "facility_name",
                       test = FALSE,
                       addOverall = TRUE) 

t1_overall <- print(out1,
            cramVars = c("household_water_loc"))

# Create row labels
t1lab <- c("N",
           "Age Category (%)", "0-1 month", "2-11 months", "12-59 months",
            "Caregiver Relationship (%)", "Mother and father", "Mother and grandmother", "Mother only", "Father only", "Grandmother only", "Grandfather only", "Sibling", "Other family member", "Community member", "Caregiver Age (mean (SD))", 
            "Maternal Education (highest level attended) (%)", "Primary", "Post-Primary/Vocational", "Secondary", "Diploma/Certificate", "Bachelors degree or equivalent", "Masters degree or equivalent", 
              "Other", "Never attended any formal schooling", "Declined",
            "Household head (%)", "Female", "Mother of sick child", "Grandmother (maternal)", "Grandmother (paternal)", "Other female", "Male", "Father of sick child", "Grandfather (maternal)", "Grandfather (paternal)", "Other male", "Unknown/Uncertain", "Declined",
            "What kind of toilet facility do members of your household usually use? (%)", "Flush or pour-flush toilet", "Ventilated improved pit latrine", "Pit latrine with slab", "Pit latrine without slab/open pit", "Composting toilet", "Bucket", "Hanging toilet", "No facility/bush", "Other", "Unknown/Uncertain", "Declined",
            "What type of fuel is mainly used for cooking in the household? (%)", "Firewood","Charcoal", "Solar",  "Biomass fuel", "Cooking gas (LPG fuel)", "Electricity", "Other", "Unknown/Uncertain", "Declined",
            "Household water location = In the house or grounds/ Outside the grounds (%)",
            "What is the main material of the floor of the household? (%)", "Natural", "Earth", "Sand", "Clay", "Mud", "Dung", "Rudimentary", "Tablets/Wood planks", "Palm", "Bamboo", "Mat", "Adobe", "Finished", "Parquet", "Vinyl", "Linoleum", "Ceramic,tile", "Carpet", "Stone, cement", "Bricks")


# Add row labels
rownames(t1_overall) <- c(t1lab)

# Table formatting
t1 <- kable(t1_overall, col.names = c(" ", "Overall", "Facility 1", "Facility 2")) %>%
  kable_styling(bootstrap_options=c("striped","hover","condensed"), position = "center")  %>%
  add_indent(c(3:5, 7:15, 18:26, 28:39, 41:51, 53:61, 64:83)) %>%
  pack_rows("Demographic Characteristics", 2, 26) %>%
  pack_rows("Household Characteristics", 27, 83)
```
`r t1`

# Table 2: Patient clinical and care seeking characteristics. {.tabset}

```{r include=FALSE}
# TO ADD: travel_time, ?medical_hx + fix travel_cost
# NEED TO WORK ON TIGHTENING UP THIS TABLE

# Specify all the variables you want to treat as factors
factorVars <- c("visit_rsn_illness", "visit_rsn_trauma", "visit_rsn_immunize", "visit_rsn_routine", "cg_report_cough", "cg_report_rapidbreathing", "cg_report_fever", "cg_report_diarrhea", "cg_report_vomit", "cg_report_other")

# Specify all the variables to include
myVars <- c("cg_report_cough", "cg_report_rapidbreathing", "cg_report_fever", "cg_report_diarrhea", "cg_report_vomit", "cg_report_other", "travel_mode", "travel_cost", "care_locations_num", "visit_rsn_illness", "visit_rsn_trauma", "visit_rsn_immunize", "visit_rsn_routine")

# CreateTableOne:
out2 <- CreateTableOne(vars = myVars,
                       data = df,
                       factorVars = factorVars,
                       strata = "facility_name",
                       test = FALSE,
                       addOverall = TRUE) 

t2_overall <- print(out2)

# Create row labels -- to be done individually
# t2lab <- c("N",
#            "Illness", "Trauma (burns, injuries, wounds)", "Immunization", "Routine monitoring (growth, chronic conditions)",
#             "Number of locations visited for this illness (mean (SD))",
#             "Walking", "Bicycle", "Motorcycle", "Public mini-van/bus", "Rickshaw", "Pulbic taxi", "Private taxi", "Own private car", "Shared car", "Pack animals/carriage", "Other",
#             "Travel time to arrive at clinic (%)", "<30 minutes", "30-60 minutes", "1-2 hours", ">2 hours",
#             "Estimated amount of money spent for transport to arrive at clinic (%)",
#             "Symptoms reported by caregiver (%)", "Cough", "Difficulty/rapid breathing", "Fever", "Diarrhea", "Vomiting", "Other")


# Add row labels
#rownames(t2_overall) <- c(t2lab)

# Table formatting
t2 <- kable(t2_overall) %>%
  kable_styling(bootstrap_options=c("striped","hover","condensed"), position = "center") %>%
  pack_rows("Symptoms reported by caregiver", 2, 7) %>%
  pack_rows("Travel mode", 8, 16)
```
`r t2`

# Table 2a: Basic measurements and physical exam. {.tabset}

```{r include=FALSE}
# Specify all the variables you want to treat as factors -- already factored, no need to pass through factor argument
#factorVars <- c()

# Specify all the variables to include
myVars <- c("weight_yn", "weight", "height_yn", "height", "muac_yn", "muac", "wfh_yn", "wfh", "temp_yn", "temp", "hb_yn", "hb")

# CreateTableOne:
out2a <- CreateTableOne(vars = myVars,
                       data = df,
                      # factorVars = factorVars,
                       strata = "facility_name",
                       test = FALSE,
                       addOverall = TRUE) 

t2a_overall <- print(out2a, showAllLevels = TRUE)

# Create row labels
t2alab <- c("N", "Weight recorded (%)", "", "", "Weight (kg, mean (SD))", "Height recorded (%)", "", "Height (cm, mean (SD))", "MUAC recorded (%)", "", "", "MUAC (cm, mean (SD))", "Weight-for-height recorded (%)", "", "WFH (mean (SD))", "Temperature recorded (%)", "", "Temperature (C, mean (SD))", "Hb recorded (%)", "", "", "Hb (g/dL, mean (SD))")


# Add row labels
rownames(t2a_overall) <- c(t2alab)

# Table formatting
t2a <- kable(t2a_overall, col.names = c(" ", " ", "Overall", "Facility 1", "Facility 2")) %>%
  kable_styling(bootstrap_options=c("striped","hover","condensed"), position = "center")
```
`r t2a`

# Table 3: Use of PO device across facilities. {.tabset}

```{r include=FALSE}
# Specify all the variables you want to treat as factors
factorVars <- c("used_po_yn", "correct_use_yn", "clinical_measures_complete")

# Specify all the variables to include in table (both continuous and categorical)
myVars <- c("used_po_yn", "correct_use_yn", "po_duration_min", "consult_duration_min", "clinical_measures_complete")

t3lab <- c("N", "Used PO device during encounter (%)", "PO device used correctly (%)", "No", "Yes", "Yes for some measures but not all", "Duration of PO device use, minutes (mean (SD))", "Consult duration, minutes (mean (SD))", "All clinical measures (SpO2, PR, RR, Temp) collected (%)")

out3 <- CreateTableOne(vars = myVars,
               data = df,
               factorVars = factorVars,
               strata = "facility_name",
               test = FALSE,
               addOverall = TRUE)
out3_overall <- print(out3)
rownames(out3_overall) <- c(t3lab) # Add row labels

out3 <- kable(print(out3_overall), col.names = c(" ", "Overall", "Facility 1", "Facility 2")) %>%
  kable_styling(bootstrap_options=c("striped","hover","condensed"), position = "center") %>%
  add_indent(4:6)
```
`r out3`

The PO device was used consistently across encounters except for:

* `r sum(df_og$no_po_reason==1, na.rm = T)` instances where the device was broken
* `r sum(df_og$no_po_reason==2, na.rm = T)` instances where the battery was not charged
* `r sum(df_og$no_po_reason==3, na.rm = T)` instances where the device was being used in another part of the facility
* `r sum(df_og$no_po_reason==4, na.rm = T)` instances where the device was missing
* `r sum(df_og$no_po_reason==5, na.rm = T)` instances where the child was too fussy
* `r sum(df_og$no_po_reason==6, na.rm = T)` instances where the caregiver did not want it
* `r sum(df_og$no_po_reason==7, na.rm = T)` instances where the provider decided it was not needed

# Table 4: IMCI classifications per treating provider.
```{r include=FALSE}
# Specify all the variables you want to treat as factors
factorVars <- c("mainsxs_assessed_yn", "danger_assessed_yn", "cough_dx_yn","cough_dx", "diarrhea_dx_yn", "diarrhea_dx", "fever_dx_yn", "fever_dx", "ear_dx_yn", "ear_dx", "malnutrition_dx_yn", "malnutrition_dx", "anemia_dx_yn", "anemia_dx", "hiv_dx_yn", "hiv_dx")

# Specify all the variables to include in table (both continuous and categorical)
myVars <- c("mainsxs_assessed_yn", "danger_assessed_yn", "cough_dx_yn","cough_dx", "diarrhea_dx_yn", "diarrhea_dx", "fever_dx_yn", "fever_dx", "ear_dx_yn", "ear_dx", "malnutrition_dx_yn", "malnutrition_dx", "anemia_dx_yn", "anemia_dx", "hiv_dx_yn", "hiv_dx")

t4lab <- c("N", "All main symptoms assessed by provider (%)",
           "All danger signs assessed by provider (%)",
           "Dx given for cough/shortness of breath (%)", "Cough or shortness of breath classification (%)", "Green", "Yellow", "Red",
           "Dx given for diarrhea (%)", "Diarrhea classification (%)", "Green", "Yellow", "Red",
           "Dx given for fever (%)", "Fever classification(%)", "Green", "Yellow", "Red",
           "Dx given for ear problem (%)", "Ear problem classification (%)", "Green", "Yellow", "Red",
           "Dx given for malnutrition (%)", "Malnutrition classification (%)", "Green", "Yellow", "Red",
           "Dx given for anemia (%)", "Anemia classification (%)", "Green", "Yellow", "Red",
           "Dx given for HIV (%)", "HIV classification - Green (%)")

out4 <- CreateTableOne(vars = myVars,
               data = df,
               factorVars = factorVars,
               strata = "facility_name",
               test = FALSE,
               addOverall = TRUE)
out4_overall <- print(out4)
rownames(out4_overall) <- c(t4lab) # Add row labels

out4 <- kable(print(out4_overall), col.names = c(" ", "Overall", "Facility 1", "Facility 2")) %>%
  kable_styling(bootstrap_options=c("hover","condensed"), position = "center") %>%
  add_indent(c(6:8, 11:13, 16:18, 21:23, 26:28, 31:33, 35)) %>%
  pack_rows("Cough/Shortness of breath", 4, 8) %>%
  pack_rows("Diarrhea", 9, 13) %>%
  pack_rows("Fever", 14, 18) %>%
  pack_rows("Ear problem", 19, 23) %>%
  pack_rows("Malnutrition", 24, 28) %>%
  pack_rows("Anemia", 29, 33) %>%
  pack_rows("HIV", 34, 35) %>%
  row_spec(6, bold = T, color = "#0cbd06", background = "white") %>%
  row_spec(7, bold = T, color = "#eda702", background = "white") %>%
  row_spec(8, bold = T,color = "salmon", background = "white") %>%
  row_spec(11, bold = T, color = "#0cbd06", background = "white") %>%
  row_spec(12, bold = T, color = "#eda702", background = "white") %>%
  row_spec(13, bold = T,color = "salmon", background = "white") %>%
  row_spec(16, bold = T, color = "#0cbd06", background = "white") %>%
  row_spec(17, bold = T, color = "#eda702", background = "white") %>%
  row_spec(18, bold = T,color = "salmon", background = "white") %>%
  row_spec(21, bold = T, color = "#0cbd06", background = "white") %>%
  row_spec(22, bold = T, color = "#eda702", background = "white") %>%
  row_spec(23, bold = T,color = "salmon", background = "white") %>%
  row_spec(26, bold = T, color = "#0cbd06", background = "white") %>%
  row_spec(27, bold = T, color = "#eda702", background = "white") %>%
  row_spec(28, bold = T,color = "salmon", background = "white") %>%
  row_spec(31, bold = T, color = "#0cbd06", background = "white") %>%
  row_spec(32, bold = T, color = "#eda702", background = "white") %>%
  row_spec(33, bold = T,color = "salmon", background = "white") %>%
  row_spec(35, bold = T, color = "#0cbd06", background = "white")
```
`r out4`

# Table 5: Clinical outcomes following implementation of PO device. {.tabset}
Thresholds used are as follows (as defined in SAP):

- Hypoxia:
  +	≤90% (severe)
  +	≤92% (moderate)
  
- Fever: ≥38C

- Fast breathing: 
  + <12 months
    +	`>`50 bpm
  + 12-35 months
    +	`>`40 bpm
  + 36-60 months
    +	`>`30 bpm

- Tachycardia: 
  + <12 months
    +	`>`180 bpm 
  + 12-60 months
    +	`>`140 bpm

```{r include=FALSE}
# Specify all the variables you want to treat as factors -- note: lab_yn not collected in senegal but should be added in kenya and tanzania
factorVars <- c("hypoxia_severe", "hypoxia_moderate", "fever", "fast_breathing", "tachycardia", "abx_yn", "rx_yn")

# Specify all the variables to include in table (both continuous and categorical)
myVars <- c("hypoxia_severe", "hypoxia_moderate", "fever", "fast_breathing", "tachycardia","abx_yn", "rx_yn", "refferal")

t5lab <- c("N", "Severe hypoxia (%)", "Moderate hypoxia (%)", "Fever", "Fast breathing (%)", "Tachycardia (%)", 
           "Antibiotics given (%)", "Other prescriptions given (%)",
           "Referral advice (%)", "Urgent", "Non-urgent", "Recorded, not readable", "Recorded, no referral")

out5 <- CreateTableOne(vars = myVars,
               data = df,
               factorVars = factorVars,
               strata = "facility_name",
               test = FALSE,
               addOverall = TRUE)
out5_overall <- print(out5)
rownames(out5_overall) <- c(t5lab) # Add row labels

out5 <- kable(print(out5_overall), col.names = c(" ", "Overall", "Facility 1", "Facility 2")) %>%
  kable_styling(bootstrap_options=c("striped","hover","condensed"), position = "center") %>%
  add_indent(10:13) %>%
  pack_rows("Clinical outcomes identified", 2, 6) %>%
  pack_rows("Treatment and referrals", 7, 13)
```
`r out5`

# Boxplots of PO measures. {.tabset}

## SpO2
```{r}
boxplot(spo2~age_cat, data=df, main = "Masimo SpO2 Measurement", ylab = "SpO2 (%)", xlab = "Measurement by Age Category")
```

## Pulse Rate
```{r}
boxplot(pr~age_cat, data=df, main = "Masimo PR Measurement", ylab = "PR (beats per minute)", xlab = "Measurement by Age Category")
```

## Respiratory Rate
```{r}
boxplot(rr~age_cat, data=df, main = "Masimo RR Measurement", ylab = "RR (breaths per minute)", xlab = "Measurement by Age Category")
```

## Temperature
```{r}
boxplot(temp_po~age_cat, data=df, main = "Masimo Temperature Measurement", ylab = "Temperature (C)", xlab = "Measurement by Age Category")
```